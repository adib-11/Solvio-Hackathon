# Story 1.1: Project Foundation Setup

## Status
Approved

## Story
**As a** developer,
**I want** to set up the monorepo, serverless backend, database, and React frontend,
**so that** we have a stable foundation for building all subsequent features.

## Acceptance Criteria
1. (AC1): The monorepo structure is created and pushed to a Git repository.
2. (AC2): The serverless backend (Node.js) is initialized and configured.
3. (AC3): The serverless database (e.g., Supabase) is provisioned and connection details are secured.
4. (AC4): The React (Next.js) frontend application is initialized and configured within the monorepo.
5. (AC5): The database schema for a "Product" (Title, Price, ImageURL) is defined and migrated.

## Tasks / Subtasks

- [ ] Task 1: Initialize Monorepo Structure (AC: 1)
  - [ ] Create root `package.json` with workspaces configuration
  - [ ] Create `apps/web/` directory for Next.js application
  - [ ] Create `packages/shared/` directory for shared types
  - [ ] Create `packages/config/` directory for shared configurations
  - [ ] Create `docs/` directory structure
  - [ ] Initialize Git repository and create `.gitignore`
  - [ ] Create `README.md` with project overview
  
- [ ] Task 2: Setup Next.js Frontend Application (AC: 2, 4)
  - [ ] Initialize Next.js application in `apps/web/` using TypeScript (~14.x)
  - [ ] Configure `next.config.js` for monorepo structure
  - [ ] Setup Tailwind CSS (`tailwind.config.ts`, `postcss.config.js`)
  - [ ] Create base project structure: `src/app/`, `src/components/`, `src/lib/`, `src/services/`, `src/context/`, `src/hooks/`, `src/styles/`
  - [ ] Configure TypeScript with `tsconfig.json`
  - [ ] Install and configure UI component library (MUI or Chakra UI)
  - [ ] Create basic layout component and root page
  - [ ] Verify dev server runs successfully
  
- [ ] Task 3: Setup Serverless Backend (AC: 2)
  - [ ] Create API routes directory structure: `src/app/api/`
  - [ ] Setup initial API route structure (auth, owner, products, webhook)
  - [ ] Install NextAuth.js (~5.x) for authentication
  - [ ] Create basic API route handler template
  - [ ] Configure middleware.ts for route protection
  
- [ ] Task 4: Provision and Configure Supabase Database (AC: 3)
  - [ ] Create Supabase project
  - [ ] Save Supabase URL and keys securely
  - [ ] Install `@supabase/supabase-js` package
  - [ ] Create `.env.example` with required environment variables
  - [ ] Create `apps/web/src/lib/db.ts` with Supabase client setup
  - [ ] Document database connection setup in README
  
- [ ] Task 5: Define and Migrate Database Schema (AC: 5)
  - [ ] Create `owners` table with all required fields (id, email, hashed_password, business_name, subdomain, facebook_page_id, encrypted_facebook_page_token, created_at, updated_at)
  - [ ] Create `products` table with all required fields (id, owner_id, title, price, image_url, created_at, updated_at)
  - [ ] Add CHECK constraint on products.price field for validation
  - [ ] Create indexes: idx_owners_subdomain, idx_products_owner_id, idx_products_title
  - [ ] Create trigger function for auto-updating `updated_at` timestamps
  - [ ] Apply triggers to both tables
  - [ ] Verify schema migration success
  
- [ ] Task 6: Create Shared TypeScript Types (AC: 1, 5)
  - [ ] Create `packages/shared/src/types.ts`
  - [ ] Define `Owner` interface matching database schema
  - [ ] Define `Product` interface matching database schema
  - [ ] Export types for use across monorepo
  
- [ ] Task 7: Setup Testing Infrastructure (AC: 1)
  - [ ] Install Jest and React Testing Library
  - [ ] Configure Jest (`jest.config.js`)
  - [ ] Create sample test file to verify setup
  - [ ] Add test scripts to `package.json`
  
- [ ] Task 8: Configure Development Environment (AC: 1, 2, 3, 4)
  - [ ] Setup environment variable structure
  - [ ] Configure NextAuth.js environment variables (NEXTAUTH_SECRET, NEXTAUTH_URL)
  - [ ] Configure Supabase environment variables (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY)
  - [ ] Configure Vercel Blob storage variables (BLOB_READ_WRITE_TOKEN)
  - [ ] Configure Facebook Messenger API variables (FACEBOOK_APP_SECRET, FACEBOOK_VERIFY_TOKEN)
  - [ ] Document all environment variables in `.env.example`
  - [ ] Test local development server startup
  
- [ ] Task 9: Initial Git Commit and Push (AC: 1)
  - [ ] Review all files and structure
  - [ ] Create initial commit with foundation setup
  - [ ] Push to remote Git repository
  - [ ] Verify repository structure matches architecture specification

## Dev Notes

### Project Structure
This story establishes the monorepo foundation following the architecture specification.
[Source: architecture/unified-project-structure.md]

**Monorepo Root Structure:**
```
ai-chat-web-prototype/
├── apps/web/                    # Next.js Frontend + API Routes
├── packages/shared/             # Shared types/utils
├── packages/config/             # Shared configs
├── docs/                        # Documentation
├── .env.example
├── .gitignore
├── package.json                 # Root package.json (workspaces)
├── tsconfig.json
└── README.md
```

**Next.js App Structure (`apps/web/src/`):**
```
src/
├── app/                         # Next.js App Router
│   ├── (admin)/                 # Protected admin routes
│   ├── (auth)/                  # Auth pages (login, signup)
│   ├── api/                     # API Routes
│   ├── [subdomain]/             # Dynamic subdomain routes
│   ├── layout.tsx
│   └── page.tsx
├── components/                  # React components
├── context/                     # React Context providers
├── hooks/                       # Custom React hooks
├── lib/                         # DB client, utilities
├── services/                    # API service layer
└── styles/                      # Global styles
```

### Tech Stack
[Source: architecture/tech-stack.md]

**Core Technologies:**
- **Frontend Language:** TypeScript ~5.x
- **Frontend Framework:** Next.js ~14.x (React)
- **UI Component Library:** MUI or Chakra UI (latest)
- **State Management:** React Context
- **Backend Language:** TypeScript ~5.x
- **Backend Framework:** Next.js API Routes ~14.x
- **Database:** Supabase (PostgreSQL) - latest
- **File Storage:** Vercel Blob - latest
- **Authentication:** NextAuth.js ~5.x
- **Testing:** Jest + React Testing Library (latest)
- **CSS Framework:** Tailwind CSS (latest)

**Rationale:**
- Next.js provides SSR, SSG, and API routes in one framework
- Supabase offers serverless PostgreSQL with generous free tier
- NextAuth.js is the standard for Next.js authentication
- Tailwind CSS integrates well with component libraries

### Database Schema
[Source: architecture/database-schema.md]

**Owners Table:**
```sql
CREATE TABLE owners (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email TEXT UNIQUE NOT NULL,
    hashed_password TEXT NOT NULL,
    business_name TEXT NOT NULL,
    subdomain TEXT UNIQUE NOT NULL,
    facebook_page_id TEXT,
    encrypted_facebook_page_token TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);
```

**Products Table:**
```sql
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    owner_id UUID NOT NULL REFERENCES owners(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    price TEXT NOT NULL CHECK (price ~ '^\d+(\.\d{1,2})?$'),
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);
```

**Indexes:**
- `idx_owners_subdomain` on owners(subdomain)
- `idx_products_owner_id` on products(owner_id)
- `idx_products_title` on products(title) - for search functionality

**Triggers:**
- Auto-update `updated_at` on both tables using `trigger_set_timestamp()` function

### Data Models
[Source: architecture/data-models.md]

**Owner Interface:**
```typescript
interface Owner {
  id: string;           // UUID
  email: string;
  businessName: string;
  subdomain: string;
  facebookPageId?: string;
  // Note: hashedPassword and facebookPageToken are backend-only
}
```

**Product Interface:**
```typescript
interface Product {
  id: string;       // UUID
  ownerId: string;  // UUID
  title: string;
  price: string;    // Using String type
  imageUrl: string;
}
```

### Backend Architecture
[Source: architecture/backend-architecture.md]

**API Routes Structure:**
```
apps/web/src/app/api/
├── auth/
│   └── [...nextauth]/route.ts
├── owner/
│   └── subdomain/route.ts
├── products/
│   └── route.ts
└── webhook/
    └── messenger/route.ts
```

**Supabase Client Setup:**
Create `apps/web/src/lib/db.ts` with Supabase client:
```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseKey);
```

**Authentication:**
- Use NextAuth.js Credentials Provider for email/password
- Protect `/admin/*` routes using middleware
- Session checking in API routes for protected endpoints

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Component Organization:**
```
components/
├── ui/                  # Basic, reusable UI elements
├── products/            # Product related components
├── owner/               # Admin dashboard components
└── auth/                # Auth components
```

**State Management:**
- Use React Context for global auth state
- Create `apps/web/src/context/AuthContext.tsx`
- Local state management with `useState` for feature-specific state

**API Service Layer:**
- Create `apps/web/src/services/apiClient.ts` with axios wrapper
- Create domain-specific services (e.g., `productService.ts`)
- Never call fetch/axios directly from components

### Development Workflow
[Source: architecture/development-workflow.md]

**Prerequisites:**
- Node.js ~v20.x
- npm/pnpm/yarn
- Git

**Development Commands:**
```bash
npm install                    # Install dependencies
npm run dev --workspace=web    # Start dev server
npm test                       # Run tests
```

**Required Environment Variables:**
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...

# NextAuth.js
NEXTAUTH_SECRET=...
NEXTAUTH_URL=http://localhost:3000

# Vercel Blob Storage
BLOB_READ_WRITE_TOKEN=...

# Facebook Messenger API
FACEBOOK_APP_SECRET=...
FACEBOOK_VERIFY_TOKEN=...
```

### Coding Standards
[Source: architecture/coding-standards.md]

**Critical Rules:**
- Use TypeScript; avoid `any`; use shared types from `packages/shared`
- Access environment variables via `process.env`
- Use API service layer in frontend
- Basic try/catch error handling; log errors via `console.error`
- Use Tailwind CSS utilities for styling
- Follow basic security (input validation, auth checks)

**Naming Conventions:**
- Files (TS/TSX): `PascalCase.tsx`/`.ts` (frontend), `kebab-case.ts` (API routes)
- Components: `PascalCase`
- Hooks: `useCamelCase`
- Variables/Functions: `camelCase`
- CSS Classes: Tailwind utilities
- DB Tables/Columns: `snake_case`

### Testing
[Source: architecture/testing-strategy.md]

**Testing Philosophy:**
- Primarily Unit Tests for FE and BE logic
- Aim for >70% coverage on critical logic

**Test Organization:**
- Frontend: Jest + React Testing Library (`*.test.tsx` colocated)
- Backend: Jest (`*.test.ts` colocated)
- Mock API calls in frontend tests
- Mock DB calls in backend tests

**Test Commands:**
- Run tests: `npm test`
- Tests run in Vercel CI pipeline

### Project Structure Notes
All file paths and structures align with the Unified Project Structure specification. No conflicts detected between epic requirements and architecture documentation.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
